---
title: "Geovisualization and Spatial Analysis"
author: "Kim Antunez & Timothée Giraud"
date: "Massive spatial data: challenges in acquisition, treatment and use for territories"
output: 
  html_document: 
    number_sections: yes
    theme: journal
---


```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
## Global options
options(max.print="90")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=90)
options(width = 90)

# no margins
knit_hooks$set(nm = function(before, options, envir){
  if (before){
    par(mar=c(0,0,0,0))
  } 
})

# title margins
knit_hooks$set(sm = function(before, options, envir){
  if (before){
    par(mar=c(0,0,1.2,0))
  } 
})


```

# Introducing the R Spatial Ecosystem (30 min)
## The basics

### rgdal, sp, rgeos

* `rgdal` : interface entre R et les librairies GDAL ([Geospatial Data Abstraction Library](http://www.gdal.org/)) et [PROJ4](https://github.com/OSGeo/proj.4).

* `sp` : classes et methodes pour les données spatiales dans R.

* `rgeos` : accès à la librairie d'opérations spatiales GEOS ([Geometry Engine - Open Source](http://trac.osgeo.org/geos/)) :  area, perimeter, distances, dissolve, buffer, overlap, union, contains...

### sf

* Les fonctionnalités de `sp`, `rgeos` et `rgdal` dans un package unique. 

* Manipulation plus aisée, objets plus simples

* Auteur principal et *maintainer* : Edzer Pebesma (auteur de `sp`)

* Compatible avec les syntaxes *pipe* et les opérateurs du `tidyverse`.


Format des objets spatiaux `sf`

<img src="./img/sf.png" alt="format sf" style="border:0px"/>


Import de données

```{r}
library(sf)
mtq <- st_read("data/mtq/martinique.shp")
```


Affichage de données

```{r, nm=TRUE}
plot(st_geometry(mtq))
```

Extraire les centroïdes

```{r, nm=TRUE}
mtq_c <- st_centroid(mtq)
plot(st_geometry(mtq))
plot(st_geometry(mtq_c), add=TRUE, cex=1.2, col="red", pch=20)
```

Construire une matrice de distances

```{r, nm=TRUE}
mat <- st_distance(x=mtq_c,y=mtq_c)
mat[1:5,1:5]
```

Agréger des polygones
```{r, nm=TRUE}
mtq_u <- st_union(mtq)
plot(st_geometry(mtq), col="lightblue")
plot(st_geometry(mtq_u), add=T, lwd=2, border = "red")
```


Construire une zone tampon

```{r, nm=TRUE}
mtq_b <- st_buffer(x = mtq_u, dist = 5000)
plot(st_geometry(mtq), col="lightblue")
plot(st_geometry(mtq_u), add=T, lwd=2)
plot(st_geometry(mtq_b), add=T, lwd=2, border = "red")

```


Réaliser une intersection 

```{r, nm=TRUE}
m <- rbind(c(700015,1624212), c(700015,1641586), c(719127,1641586), 
           c(719127,1624212), c(700015,1624212))
p <- st_sf(st_sfc(st_polygon(list(m))), crs = st_crs(mtq))
plot(st_geometry(mtq))
plot(p, border="red", lwd=2, add=T)
```


```{r, nm=TRUE, warning=F}
mtq_z <- st_intersection(x = mtq, y = p)
plot(st_geometry(mtq))
plot(st_geometry(mtq_z), col="red", border="green", add=T)
```


Construire des polygones de Voronoi  
<small>google: "st_voronoi R sf" (https://github.com/r-spatial/sf/issues/474 & https://stackoverflow.com/questions/45719790/create-voronoi-polygon-with-simple-feature-in-r)
</small>
```{r, nm=TRUE}
mtq_v <- st_voronoi(x = st_union(mtq_c))
mtq_v <- st_intersection(st_cast(mtq_v), st_union(mtq))
mtq_v <- st_join(x = st_sf(mtq_v), y = mtq_c, join=st_intersects)
mtq_v <- st_cast(mtq_v, "MULTIPOLYGON")
plot(st_geometry(mtq_v), col='lightblue')
```



## Mapping

  - static:
      - ggplot2 + ggspatial
      - tmap 
      - **cartography**
  - dynamic/interactive
      - leaflet
      - mapview
      
## Spatial modelling and MISC
[CRAN Task View: Analysis of Spatial Data](https://CRAN.R-project.org/view=Spatial)


# Exploration of sirene & osm db for restaurants

See file data_prep.R for data extraction. 

```{r}
# spatial data management
library(sf)
# cartography
library(cartography)
# smooth density computation
library(spatstat)
library(raster)
library(maptools)
# interactive mapping
library(mapview)
```


## Display points
```{r, cache=TRUE}
# load data
adm <- readRDS("data/iris_p13.rds")
feat_sir <- readRDS("data/sir_p13.rds")
feat_osm <- readRDS("data/osm_p13.rds")

nrow(feat_sir)
nrow(feat_osm)

par(mar = c(0,0,1.2,0), mfrow = c(1,2))

plot(st_geometry(adm), col = "ivory1", border = "ivory3",lwd =0.5,bg = "#FBEDDA")
plot(st_geometry(feat_sir), col = "red", pch = 20, add=T, cex = 0.5)
layoutLayer(title = "SIR", sources="", author="", scale = NULL, frame=FALSE)
legend(x = "topright", legend = "= 1 restaurant", pch = 20, pt.cex = 0.5, cex = 0.7, col = "red")

plot(st_geometry(adm), col = "ivory1", border = "ivory3",lwd =0.5,bg = "#FBEDDA")
plot(st_geometry(feat_osm), col = "red", pch = 20, add=T, cex = 0.5)
layoutLayer(title = "OSM", sources="", author="", scale = .5, north = T, frame=FALSE)
```




## Count points in admin units

```{r, cache=TRUE}
inter_osm <- st_intersects(adm, feat_osm)
inter_sir <- st_intersects(adm, feat_sir)

adm <- st_sf(adm[,1:2,drop = T], 
             n_osm = sapply(X = inter_osm, FUN = length), 
             n_sir = sapply(X = inter_sir, FUN = length), 
             geometry = st_geometry(adm))

par(mar = c(0,0,1.2,0), mfrow = c(1,2))
plot(st_geometry(adm), col = "ivory1", border = "ivory3",lwd =0.5,bg = "#FBEDDA")
propSymbolsLayer(adm, var = "n_sir", inches = 0.1)
layoutLayer(title = "SIR", sources="", author="", scale = NULL, frame=FALSE)

plot(st_geometry(adm), col = "ivory1", border = "ivory3",lwd =0.5,bg = "#FBEDDA")
propSymbolsLayer(adm, var = "n_osm", inches = 0.1)
layoutLayer(title = "OSM", sources="", author="", scale = .5, north = T, frame=FALSE)


# plot(adm$n_sir, adm$n_osm, asp = T, xlim = c(0,55), pch = 21, bg = "red")
# text(adm$n_sir, adm$n_osm, labels = adm$CODE_IRIS, cex = 0.5, pos = 2)
# x <-lm(formula = adm$n_osm~adm$n_sir)
# abline(a = x$coefficients )


```


## Interactive visualisation

Explore datasets interactively

The default is not bad:
```{r, cache=TRUE}
mapview(feat_sir) + mapview(feat_osm, col.regions = "red")
```

mapview is hightly customizable:

```{r, cache=TRUE}
mapview(feat_sir, map.types = "OpenStreetMap", col.regions = "#940000", 
        label = paste(feat_sir$L2_NORMALISEE, feat_sir$NOMEN_LONG, sep=" - "),
        color = "white", legend = TRUE, layer.name = "SIRENE", 
        homebutton = FALSE, lwd = 0.5) +
  mapview(feat_osm, col.regions = "#000094", color = "white", legend = TRUE, 
          label = feat_osm$name,
          lwd = 0.5, layer.name = "OSM",  homebutton = FALSE)
 
```







## count points in regular grid

```{r, cache=TRUE}
fufun2 <- function(feat,adm, cs = 500){
  grid <- st_make_grid(x = adm, cellsize = cs, what = "polygons")
  x <- st_intersects(grid, feat)
  gg <- st_sf(n = sapply(X = x, FUN = length), grid)
  plot(adm$geometry, col = "ivory1", border = "ivory3",lwd =0.5,bg = "#FBEDDA")
  choroLayer(gg[gg$n>0,], var = "n", border= NA, breaks = c(1,4,6,9,12,14,17,19,22), 
             col = carto.pal("wine.pal", 8), add=TRUE)
}
```


```{r, cache=TRUE}
par(mar = c(0,0,1.2,0), mfrow = c(2,3))
fufun2(feat_sir, adm, 50)
fufun2(feat_sir, adm, 100)
fufun2(feat_sir, adm, 150)
fufun2(feat_osm, adm, 50)
fufun2(feat_osm, adm, 100)
fufun2(feat_osm, adm, 150)


```





## smooth density analysis

Define a function that compute smoothed restaurant density and map it.


```{r, cache=TRUE}
fufun <- function(feat, adm, title, sigma = 100,res = 50){
  bb <- as(feat, "Spatial")
  bbowin <- as.owin(as(adm, "Spatial"))
  pts <- coordinates(bb)
  p <- ppp(pts[,1], pts[,2], window=bbowin)
  ds <- density.ppp(p, sigma = sigma, eps = res)
  rasdens <- raster(ds) * 1000 * 1000
  proj4string(rasdens) <- "+init=epsg:2154"
  rasdens <- rasdens+1
  bks <- getBreaks(values(rasdens), nclass = 12, method = "equal")
  cols <- mapview::mapviewGetOption("raster.palette")(length(bks)-1)
  plot(adm$geometry, col = NA, border = NA, main="", bg = "#FBEDDA")
  plot(rasdens, breaks = bks, col=cols, add = T,legend=F)
  legendChoro(pos = "topright",cex = 0.7, title.cex = 0.7,
              title.txt = "resto per km2)",
              breaks = bks-1, nodata = FALSE,values.rnd = 0,
              col = cols)
  layoutLayer(title = paste0(title), scale = .5,
              tabtitle = TRUE, frame = FALSE,
              author = "Map data © OpenStreetMap contributors, under CC BY SA. SIRENE 2018", 
              sources = "cartography 2.0.2") 
  return(invisible(rasdens))
}

```



```{r, cache=TRUE, fig.width=10}
par(mar = c(0,0,1.2,0), mfrow = c(2,3))
fufun(feat_sir, adm, "SIR 50", 50, 20)
fufun(feat_sir, adm, "SIR 100", 100, 20)
fufun(feat_sir, adm, "SIR 250", 250, 20)
fufun(feat_osm, adm, "OSM 50", 50, 20)
fufun(feat_osm, adm, "OSM 100", 100, 20)
fufun(feat_osm, adm, "OSM 250", 250, 20)
```



--------------------------------------------

--------------------------------------------

**reproducibility**

```{r}
sessionInfo()
```
